<!DOCTYPE html>
<html>
  <head>
    <title>Send in the clowns *pouet pouet*</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js" type="text/javascript"></script>
    <script src="/socket.io/socket.io.js" type="text/javascript"></script>
    <style>
      html, body{
       padding:0;
       margin:0 
      }
      body{
        background-color: rgb(7,6,10);
        height:100vh;
        font-family:'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .preview-container{
        border: rgb(100,10,20) solid 10px;
      }
      .origin-container{
        border: rgb(20,10,100) solid 10px;
      }
      p{
        position: relative;
        opacity: 0.2;
        z-index: -1;
        font-size: 8px;
        color: red;
        text-align: justify;
        transform: rotateZ(15deg);
      }
      .bg-container{
        position:absolute;
        height:100vh;
        width:100vw;
        overflow:hidden;
      }
    </style>
  </head>
  <body>
    <h1>Send in the clowns üéàü§°</h1>
    <div id="container">
      <div class="preview-container"> 
        <video src="" id="video" width="250" height="180" autoplay="true"></video>
        <canvas style="display:none;" width="250" height="180" id="preview"></canvas>
      </div>
      <div class="origin-container">
        <canvas style="display:none;" width="250" height="180" id="origin-canvas"></canvas>
        <img id="origin">
      </div>
     
    </div>
  </body>
</html>
<script>
  // connexion au serveur
  var socket = io();

  var poses = []

  // r√©cup√©ration des √©lements HTML
  var video = document.getElementById("video");
  var preview = document.getElementById("preview");
  var origin = document.getElementById("origin")
  var originCanvas = document.getElementById("origin-canvas")
  
  var ctx = preview.getContext("2d");

  // gestion de la capture webcam
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
      video.srcObject = stream;
      video.play();
    });
  }
  
  // affichage de la vid√©o d'origine
  function drawCameraIntoCanvas() {
    ctx.drawImage(video, 0, 0, preview.width, preview.height);
    drawKeypoints();
    window.requestAnimationFrame(drawCameraIntoCanvas);
  }

  drawCameraIntoCanvas();

  // initalisation de poseNet
  const poseNet = ml5.poseNet(video, modelReady);
  poseNet.on("pose", gotPoses);

  function gotPoses(results) {
    poses = results;
  }

  function modelReady() {
    console.log("model ready");
    poseNet.multiPose(video);
  }
  // dessin du nez rouge sur le visage d√©tect√©
  function drawKeypoints() {
    // pour chaque pose d√©tect√©e
    for (let i = 0; i < poses.length; i += 1) {
      // pour chaque keypoint d√©tect√©
      for (let j = 0; j < poses[i].pose.keypoints.length; j += 1) {
        let keypoint = poses[i].pose.keypoints[j];
        // dessiner le nez rouge sur le keypoint correspondant √† la position du nez
        if (keypoint.score > 0.2 && keypoint.part==='nose') {
          ctx.beginPath();
          ctx.arc(keypoint.position.x, keypoint.position.y, 10, 0, 2 * Math.PI);
          ctx.fillStyle="red";
          ctx.fill();
          ctx.strokeStyle="red"
          ctx.stroke();
        }
      }
    }
  }

  // quand le client re√ßoit une image, on change la source de l'image qui va recevoir l'ensemble des images trait√©es
  socket.on("stream",function(data){
    origin.src = data;
  });

  // toute les millisecondes on envoi l'image trait√©e
  function streamOrigin(){
    setInterval(function(){
      socket.emit("stream",preview.toDataURL("image/webp", 0.7)); // qualit√© d'image de 70%
    },0.1);
  };
  streamOrigin()
  
</script>