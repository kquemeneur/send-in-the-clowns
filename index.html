<!DOCTYPE html>
<html>
  <head>
    <title>Send in the clowns *pouet pouet*</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <!--<script src="https://unpkg.com/ml5@latest/dist/ml5.min.js" type="text/javascript"></script>-->
    <script src="/socket.io/socket.io.js" type="text/javascript"></script>
  </head>
  <body>
    <h1>Send in the clowns</h1>
    <div id="container">
      <div> 
        <video src="" id="video" style="width:30%; height: auto;" autoplay="true"></video>
        <canvas style="display:none;" id="preview"></canvas>
      </div>
      <img id="play">
      <div id="log"></div>
      
    </div>
    
  </body>
</html>
<script>
  var socket = io();

  var video = document.getElementById("video");
  var preview = document.getElementById("preview");
  var container = document.getElementById("container")
        
  preview.width = 250;
  preview.height = 180;
  
  var ctx = preview.getContext("2d");
  ctx.width = preview.width;
  ctx.height = preview.height;

  // Create a webcam capture
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
      video.srcObject = stream;
      video.play();
    });
  }

  function sleep (time) {
    return new Promise((resolve) => setTimeout(resolve, time));
  }
  
  // A function to draw the video 
  function drawCameraIntoCanvas() {
    // Draw the video element into the canvas
    ctx.drawImage(video, 0, 0, preview.width, preview.height);
    window.requestAnimationFrame(drawCameraIntoCanvas);
  }
  // Loop over the drawCameraIntoCanvas function
  drawCameraIntoCanvas();
 

  video.addEventListener('playing', function(e) {
    console.log("Ã§a stream")
    sleep(500).then(() => {
      socket.emit("stream",preview.toDataURL("image/jpeg", 1.0));
      console.log(preview.toDataURL("image/jpeg", 1.0))
    });
    
  });

  socket.on("stream",function(data){
    var item = document.createElement('div');
    container.appendChild(item);
    console.log("ehoh")
    document.getElementById("play").src = data;
  });


</script>