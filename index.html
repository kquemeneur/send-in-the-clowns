<!DOCTYPE html>
<html>
  <head>
    <title>Send in the clowns *pouet pouet*</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <!--<script src="https://unpkg.com/ml5@latest/dist/ml5.min.js" type="text/javascript"></script>-->
    <script src="/socket.io/socket.io.js" type="text/javascript"></script>
  </head>
  <body>
    <h1>Send in the clowns</h1>
    <div id="container">
      <div> 
        <video src="" id="video" style="width:30%; height: auto;" autoplay="true"></video>
        <canvas style="display:none;" id="preview"></canvas>
      </div>
      <img id="play">
      <div id="log"></div>
      
    </div>
    
  </body>
</html>
<script>
  var socket = io();

  var video = document.getElementById("video");
  var preview = document.getElementById("preview");
  var container = document.getElementById("container")
        
  preview.width = 250;
  preview.height = 180;
  
  var ctx = preview.getContext("2d");
  ctx.width = preview.width;
  ctx.height = preview.height;

  let poses = [];

  // Create a webcam capture
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
      video.srcObject = stream;
      video.play();
    });
  }
  
  // A function to draw the video and poses into the canvas.
  // This function is independent of the result of posenet
  // This way the video will not seem slow if poseNet
  // is not detecting a position
  function drawCameraIntoCanvas() {
    // Draw the video element into the canvas
    ctx.drawImage(video, 0, 0, preview.width, preview.height);
    // We can call both functions to draw all keypoints and the skeletons
    //drawKeypoints();
    //drawSkeleton();
    window.requestAnimationFrame(drawCameraIntoCanvas);
  }
  // Loop over the drawCameraIntoCanvas function
  drawCameraIntoCanvas();
  /*
  // Create a new poseNet method with a single detection
  const poseNet = ml5.poseNet(video, modelReady);
  poseNet.on("pose", gotPoses);

  // A function that gets called every time there's an update from the model
  function gotPoses(results) {
    poses = results;
  }

  function modelReady() {
    console.log("model ready");
    poseNet.multiPose(video);
  }

  // A function to draw ellipses over the detected keypoints
  function drawKeypoints() {
    // Loop through all the poses detected
    for (let i = 0; i < poses.length; i += 1) {
      // For each pose detected, loop through all the keypoints
      for (let j = 0; j < poses[i].pose.keypoints.length; j += 1) {
        let keypoint = poses[i].pose.keypoints[j];
        // Only draw an ellipse is the pose probability is bigger than 0.2
        if (keypoint.score > 0.2 && keypoint.part==='nose') {
          ctx.beginPath();
          ctx.arc(keypoint.position.x, keypoint.position.y, 30, 0, 2 * Math.PI);
          ctx.fillStyle="red";
          ctx.fill();
          ctx.strokeStyle="red"
          ctx.stroke();
        }
      }
    }
  }

  // A function to draw the skeletons
  function drawSkeleton() {
    // Loop through all the skeletons detected
    for (let i = 0; i < poses.length; i += 1) {
      // For every skeleton, loop through all body connections
      for (let j = 0; j < poses[i].skeleton.length; j += 1) {
        let partA = poses[i].skeleton[j][0];
        let partB = poses[i].skeleton[j][1];
        ctx.beginPath();
        ctx.moveTo(partA.position.x, partA.position.y);
        ctx.lineTo(partB.position.x, partB.position.y);
        ctx.stroke();
      }
    }
  }*/

  video.addEventListener('play', function(e) {
    console.log("Ã§a stream")
    console.log(socket)
    socket.emit("tarace","tamere")
    socket.emit("stream",preview.toDataURL('image/webp'));
    //socket.emit('chat message', input.value);
    //input.value = '';
    
  });
  socket.on("tarace",function(msg){
    var item = document.createElement('div');
    console.log(msg)
    item.textContent = msg
    container.appendChild(item);

  })
  socket.on("stream",function(data){
    console.log("ehoh")
    document.getElementById("play").attr('src',data);
    document.getElementById("log").text(data);
  });
  /*socket.on('video', function(video) {
    var item = document.createElement('div');
    var canvas_bis = canvas.cloneNode(true);
    console.log(video)
    item.append(canvas_bis)
    item.append(video)
    //item.append(video)
    container.appendChild(item);
  });*/

</script>